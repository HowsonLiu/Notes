# Windows编程
---
## 内核对象与句柄
### 内核对象定义
- 内核对象是对操作系统各项资源的抽象，比如文件对象，线程对象，进程对象等
- 每个内存对象实际上是一块内存块，只能有内核分配，并由内核访问
- 这块内存块实际上是一个数据结构，其成员维护这对象的相关信息（不同对象结构不同）
### 内核对象的通用属性
- 使用计数，标识有多少个进程正在使用此内核对象，为0时由操作系统释放（保证不存在引用为0的内核对象）
- 安全描述符（SD），描述组和用户的权限
### 句柄定义
- 唯一标识内核对象
- 实际上是指向指针的指针
- 仅与进程相关，不同进程相同内核对象句柄值不一样
- 句柄值实际上是进程句柄表的索引，除以4可以得到具体的索引值
### 进程的句柄表
一个进程在初始化时，系统会为其分配一个空句柄表。句柄表仅供内核对象使用，不适用与用户对象或者GDI对象。大概格式如下
|索引|指向内核对象内存块的指针|访问掩码|标志|
|:--:|:--:|:--:|:--:|
|1|0x????????|0x????????|0x????????|
|2|0x????????|0x????????|0x????????|
- 创建一个内核对象时，操作系统会为内核对象分配内存块，同时写入句柄表空的记录项中
- 关闭一个内核对象时，使用`CloseHandle`函数。忘了关闭内核对象在进程运行期间可能会发生对象泄露，但是在进程结束时操作系统会绝对保证释放所有资源
### 进程共享内核对象
- 对象句柄继承
    - 只允许父子进程之间继承
    - 句柄表中每个记录项都有一个是否可以继承的标志位
    - 创建子进程`CreateProcess`中有个bool值表明是否允许子进程继承父进程中可继承的句柄项
    - 继承后父子句柄表中可继承的句柄具有相同的索引（即相同句柄值）、访问掩码以及标志位